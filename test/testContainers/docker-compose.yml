version: '3.5'

x-scope-common: &scope-common
  volumes:
    - ./logs:/opt/test-runner/logs:rw
    - ../..:/opt/appscope
  working_dir: /opt/appscope
  privileged: true

x-java-common: &java-common
  environment:
    - LD_PRELOAD=/usr/local/scope/lib/libscope.so
  <<: *scope-common

services:

  # These tests run on all platforms; x86_64 and aarch64

  syscalls:
    image: scopeci/scope-syscalls-it
    build:
      cache_from:
        - scopeci/scope-syscalls-it
      context: .
      dockerfile: ./syscalls/Dockerfile
    <<: *scope-common

  logstream:
    image: scopeci/scope-logstream-it
    build:
      cache_from: 
        - scopeci/scope-logstream-it
      context: .
      dockerfile: ./logstream/Dockerfile
    ports:
      - 9000:9000
    <<: *scope-common

  nginx:
    image: scopeci/scope-nginx-it
    build:
      cache_from:
        - scopeci/scope-nginx-it
      context: .
      dockerfile: ./nginx/Dockerfile
    <<: *scope-common

  elastic:
    image: scopeci/scope-elastic-it
    build:
      cache_from:
        - scopeci/scope-elastic-it
      context: .
      dockerfile: ./elastic/Dockerfile
    <<: *scope-common

  tls:
    image: scopeci/scope-tls-it
    build:
      cache_from: 
        - scopeci/scope-tls-it
      context: .
      dockerfile: ./tls/Dockerfile
    <<: *scope-common

  detect_proto:
    image: scopeci/scope-detect_proto-it
    build:
      cache_from: 
        - scopeci/scope-detect_proto-it
      context: .
      dockerfile: ./detect_proto/Dockerfile
    ports:
      - 6379:6379
      - 27017:27017
    <<: *scope-common

  java8:
    image: scopeci/scope-java8-it
    build:
      cache_from: 
        - scopeci/scope-java8-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:8
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java9:
    image: scopeci/scope-java9-it
    build:
      cache_from: 
        - scopeci/scope-java9-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:9
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java10:
    image: scopeci/scope-java10-it
    build:
      cache_from: 
        - scopeci/scope-java10-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:10
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java11:
    image: scopeci/scope-java11-it
    build:
      cache_from: 
        - scopeci/scope-java11-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:11
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common

  transport:
    image: scopeci/scope-transport-it
    build:
      cache_from:
        - scopeci/scope-transport-it
      context: .
      dockerfile: ./transport/Dockerfile
    ports:
      - "9000:9000"
    <<: *scope-common

# vim: ts=2 sw=2 et :
