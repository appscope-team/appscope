// gcc ls_bad.c -o ls_bad

#define _GNU_SOURCE
#include <errno.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/resource.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/wait.h>

extern char **environ;
  
void setRlimits();
void httpRequest();
void readFiles();
int execCommand();

int
main()
{
    setRlimits();
    httpRequest();
    readFiles();
    execCommand();

    return 0;
}

// Set resource limits
void
setRlimits()
{
    struct rlimit old_lim, lim, new_lim;
  
    // Get old limits
    if( getrlimit(RLIMIT_NOFILE, &old_lim) == 0)
        printf("Old limits -> soft limit= %ld \t"
           " hard limit= %ld \n", old_lim.rlim_cur, 
                                 old_lim.rlim_max);
    else
        fprintf(stderr, "%s\n", strerror(errno));
      
    // Set new value
    lim.rlim_cur = 999999;
    lim.rlim_max = 999999;
  
    // Set limits
    if(setrlimit(RLIMIT_NOFILE, &lim) == -1)
        fprintf(stderr, "%s\n", strerror(errno));
      
    // Get new limits
    if( getrlimit(RLIMIT_NOFILE, &new_lim) == 0)
        printf("New limits -> soft limit= %ld "
         "\t hard limit= %ld \n", new_lim.rlim_cur, 
                                  new_lim.rlim_max);
    else
        fprintf(stderr, "%s\n", strerror(errno));
}

void
httpRequest()
{
}

// Read critical files
void
readFiles()
{
    FILE *fp;
    fp = fopen("/etc/passwd", "r");
    if (fp) fclose(fp);

    fp = fopen("/etc/shadow", "r");
    if (fp) fclose(fp);
}

// Exec "ls" with an LD_PRELOAD environment variable
int
execCommand()
{
    pid_t process;
    int status;
    pid_t wait_result;
    char *arg_list[] = {"/usr/bin/ls", NULL};
    setenv("LD_PRELOAD", "/tmp/libscope-web/libscope.so /usr/lib/firefox/libnss3.so", 1);

    process = fork();
    if (process < 0) {
        perror("fork");
        return 2;
    }

    if (process == 0) {
        // sub-process
        execv(arg_list[0], arg_list);
        perror("execv"); 
        return 2;
    }

    while ((wait_result = wait(&status)) != -1) {
        printf("Process %lu returned result: %d\n", (unsigned long) wait_result, status);
    }

    return 0; 
}
